#!/usr/bin/env bash

WORK_MONITOR_LAYOUT="$HOME/.dotfiles/hypr/work.layout.json"
LAYOUT_FILE=$WORK_MONITOR_LAYOUT

# Check if required tools are available
check_dependencies() {
    local missing_deps=()

    command -v hyprctl >/dev/null 2>&1 || missing_deps+=("hyprctl")
    command -v jq >/dev/null 2>&1 || missing_deps+=("jq")
    command -v socat >/dev/null 2>&1 || missing_deps+=("socat")

    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo "‚ùå Missing dependencies: ${missing_deps[*]}"
        echo "Please install the missing packages and try again."
        exit 1
    fi
}

# Check if layout file exists
check_layout_file() {
    if [[ ! -f "$LAYOUT_FILE" ]]; then
        echo "‚ùå Layout file not found: $LAYOUT_FILE"
        echo "üí° Tip: Save current layout with: hyprctl monitors -j > '$LAYOUT_FILE'"
        exit 1
    fi
}

# Get current monitors JSON
get_current_monitors() {
    hyprctl monitors -j
}

# Check if all current monitors exist in saved layout
layout_matches() {
    local current=$1
    local saved=$2

    # Check if any current monitors are missing from saved layout
    echo "$current" | jq -r '.[].model | tostring' | while IFS= read -r model; do
        if ! echo "$saved" | jq -e --arg model "$model" '[.[].model | tostring] | any(. == $model)' >/dev/null; then
            echo "‚ùå No configuration found for monitor: $model"
            return 1
        fi
    done

    return 0
}

apply_layout() {
    local current=$1
    local saved=$2

    echo "üîß Applying monitor layout..."

    # Create model-to-name mapping from current monitors
    declare -A MODEL_TO_NAME
    while IFS= read -r line; do
        model=$(jq -r '.model | tostring' <<< "$line")
        name=$(jq -r '.name' <<< "$line")
        MODEL_TO_NAME["$model"]="$name"
    done < <(echo "$current" | jq -c '.[]')

    # Apply configuration for each monitor in saved layout
    echo "$saved" | jq -c '.[]' | while read -r MONITOR; do
        model=$(jq -r '.model | tostring' <<< "$MONITOR")
        name="${MODEL_TO_NAME[$model]}"

        # Skip if monitor not currently connected
        # [ -z "$name" ] && continue

        disabled=$(jq -r '.disabled // false' <<< "$MONITOR")

        if [ "$disabled" = "true" ]; then
            echo "üö´ Disabling monitor $name ($model)"
            hyprctl keyword monitor "$name,disabled"
        else
            width=$(jq -r '.width' <<< "$MONITOR")
            height=$(jq -r '.height' <<< "$MONITOR")
            refresh=$(jq -r '.refreshRate | if type == "string" then . | tonumber? // 60 else . end | floor' <<< "$MONITOR")
            x=$(jq -r '.x' <<< "$MONITOR")
            y=$(jq -r '.y' <<< "$MONITOR")
            scale=$(jq -r '.scale' <<< "$MONITOR")
            transform=$(jq -r '.transform // 0' <<< "$MONITOR")

            echo "üñ•Ô∏è  Configuring $name ($model): ${width}x${height}@${refresh} at ${x}x${y}, scale $scale, transform $transform"
            hyprctl keyword monitor "$name,${width}x${height}@${refresh},${x}x${y},$scale,transform,$transform"
        fi
    done
}

save_current_layout() {
    echo "üíæ Saving current monitor layout to $LAYOUT_FILE"
    mkdir -p "$(dirname "$LAYOUT_FILE")"
    get_current_monitors > "$LAYOUT_FILE"
    echo "‚úÖ Layout saved successfully"
}

monitor_added() {
    echo "üîå Monitor added"
    local current=$(get_current_monitors)
    local saved=$(cat "$LAYOUT_FILE")

    if layout_matches "$current" "$saved"; then
        echo "‚úÖ All monitors have configurations. Applying layout..."
        apply_layout "$current" "$saved"
    else
        echo "‚ùå Some monitors missing configurations. Not applying layout."
    fi
}

monitor_removed() {
    echo "üîå Monitor removed"
    local current=$(get_current_monitors)
    local saved=$(cat "$LAYOUT_FILE")

    if layout_matches "$current" "$saved"; then
        echo "‚úÖ All monitors have configurations. Applying layout..."
        apply_layout "$current" "$saved"
    else
        echo "‚ùå Some monitors missing configurations. Not applying layout."
    fi
}

listen_events() {
    echo "üëÇ Listening for Hyprland monitor events..."
    echo "üí° Press Ctrl+C to stop"

    socat -U - UNIX-CONNECT:"$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock" | while read -r line; do
        case "$line" in
            "monitoradded"*)
                monitor_added
                ;;
            "monitorremoved"*)
                monitor_removed
                ;;
        esac
    done
}

show_usage() {
    echo "Hyprland Monitor Layout Manager"
    echo ""
    echo "Usage: $0 [COMMAND]"
    echo ""
    echo "Commands:"
    echo "  listen              Listen for monitor events and auto-apply layout (default)"
    echo "  apply               Apply saved layout once"
    echo "  save                Save current monitor layout"
    echo "  check               Check if current layout matches saved layout"
    echo "  help                Show this help message"
    echo ""
    echo "Layout file: $LAYOUT_FILE"
}

main() {
    check_dependencies

    case "${1:-listen}" in
        "listen")
            check_layout_file
            listen_events
            ;;
        "apply")
            check_layout_file
            local current=$(get_current_monitors)
            local saved=$(cat "$LAYOUT_FILE")

            if layout_matches "$current" "$saved"; then
                echo "‚úÖ All monitors have configurations. Applying layout..."
                apply_layout "$current" "$saved"
            else
                echo "‚ùå Some monitors missing configurations. Not applying layout."
                exit 1
            fi
            ;;
        "save")
            save_current_layout
            ;;
        "check")
            check_layout_file
            local current=$(get_current_monitors)
            local saved=$(cat "$LAYOUT_FILE")

            if layout_matches "$current" "$saved"; then
                echo "‚úÖ All current monitors have configurations in saved layout"
                exit 0
            else
                echo "‚ùå Some current monitors missing from saved layout"
                exit 1
            fi
            ;;
        "help"|"-h"|"--help")
            show_usage
            ;;
        *)
            echo "‚ùå Unknown command: $1"
            show_usage
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
