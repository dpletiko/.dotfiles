#!/usr/bin/env bash

LAYOUT_FILE="$HOME/.dotfiles/hypr/work.layout.json"

# DEPENDENCY CHECKS
command -v hyprctl >/dev/null || { echo "‚ùå Missing hyprctl"; exit 1; }
command -v jq >/dev/null || { echo "‚ùå Missing jq"; exit 1; }
command -v socat >/dev/null || { echo "‚ùå Missing socat"; exit 1; }

# GET CURRENT MONITOR MODELS AS STRINGS
CURRENT_MODELS=$(hyprctl monitors all -j | jq -r '.[].model | tostring')
echo "üñ•Ô∏è  Current monitors: $(echo "${CURRENT_MODELS//$'\n'/, }")"

# CHECK LAYOUT FILE EXISTS
[ -f "$LAYOUT_FILE" ] || { echo "‚ùå Layout file missing: $LAYOUT_FILE"; exit 1; }

# CHECK IF ALL CURRENT MODELS EXIST IN SAVED LAYOUT
ALL_PRESENT=true
while read -r model; do
    if ! jq -e --arg model "$model" '[.[].model | tostring] | any(. == $model)' "$LAYOUT_FILE" >/dev/null; then
        echo "‚ùå Missing in saved layout: $model"
        ALL_PRESENT=false
    fi
done <<< "$CURRENT_MODELS"

# APPLY LAYOUT IF ALL MODELS PRESENT
if $ALL_PRESENT; then
    echo "‚úÖ ALL CURRENT MONITORS FOUND IN SAVED LAYOUT - APPLYING CONFIG"

    # Create model-to-name mapping from current monitors
    declare -A MODEL_TO_NAME
    while IFS= read -r line; do
        model=$(jq -r '.model | tostring' <<< "$line")
        name=$(jq -r '.name' <<< "$line")
        MODEL_TO_NAME["$model"]="$name"
    done < <(hyprctl monitors -j | jq -c '.[]')

    # Apply configuration for each monitor in saved layout
    jq -c '.[]' "$LAYOUT_FILE" | while read -r MONITOR; do
        model=$(jq -r '.model | tostring' <<< "$MONITOR")
        name="${MODEL_TO_NAME[$model]}"

        # Skip if monitor not currently connected
        # [ -z "$name" ] && continue

        disabled=$(jq -r '.disabled // false' <<< "$MONITOR")

        if [ "$disabled" = "true" ]; then
            echo "üö´ Disabling monitor $name ($model)"
            hyprctl keyword monitor "$name,disabled"
        else
            width=$(jq -r '.width' <<< "$MONITOR")
            height=$(jq -r '.height' <<< "$MONITOR")
            refresh=$(jq -r '.refreshRate | if type == "string" then . | tonumber? // 60 else . end | floor' <<< "$MONITOR")
            x=$(jq -r '.x' <<< "$MONITOR")
            y=$(jq -r '.y' <<< "$MONITOR")
            scale=$(jq -r '.scale' <<< "$MONITOR")
            transform=$(jq -r '.transform // 0' <<< "$MONITOR")

            echo "üñ•Ô∏è  Configuring $name ($model): ${width}x${height}@${refresh} at ${x}x${y}, scale $scale, transform $transform"
            hyprctl keyword monitor "$name,${width}x${height}@${refresh},${x}x${y},$scale,transform,$transform"
        fi
    done
else
    echo "‚ùå ABORTING: Not all current monitors exist in saved layout"
    exit 1
fi
